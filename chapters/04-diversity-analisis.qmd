# Análisis de diversidad {.unnumbered}


::: {.callout-note appearance="simple"}
## Objetivos
Explorar el flujo de Qiime2 para analizar la diversidad microbiana, considerando la influencia de la profundidad de muestreo, la dependencia de las probabilidades en la evaluación de la diversidad, y realizar cálculos de índices de diversidad junto con curvas de rarefacción.
:::

Usted obtiene los mismos datos del Taller pasado, amplicones de 16s RNA de peces de mar y río, con la particularidad de que esta vez cada pez no tiene la misma cantidad de lecturas. Usted debe realizar análisis de diversidad de estas secuencias teniendo en cuenta la cantidad de datos que está asignando a cada análisis.

## I. Preparación de ambiente de trabajo

1. Ingrese a la cuenta del clúster.

2. En vez de crear una carpeta copiara la carpeta completa de `datasets`

3. Copie todo el directorio de `Datasets/Taller_4/` a su directorio `Taller4`

4. Ejecute los comandos de este taller en una sesión interactiva preferiblemente con 10G de memoria y al menos 4 cpus per task.

5. Cargue el módulo de QIIME2 disponible en el clúster.

:::{.callout-note appearance="simple"}
A lo largo del taller tendrá menos ayudas que en anterior, de no saber que ingresar en los *flags* de los comandos use `–help` para ver que archivos requiere. Anexe también imágenes de los pasos realizados para el resto del taller
:::

## II. Asignación taxonómica

6. primero va a realizar una asignación taxonómica de los datos con el plugin de `sklearn` utilizando la base de datos anteriormente entrenada de SILVA.

:::{.callout-important appearance="simple"}
En la carpeta que copió verá el archivo `clasificación.sh`. Primero modifique para que las rutas absolutas coincidan con sus archivos y segundo ejecútelo con `sbatch` (es decir como un *job*) ¿Qué hacer si no sabe si está corriendo?: utilice el comando `squeue –u $USER` y busque en la primera columna su código, si no está allí es porque no está corriendo y deberá ejecutarlo de nuevo.
:::

7. una vez obtenido el `taxonomy.qza` realizará la diferentes visualizaciones de este artefacto con los siguientes comandos:

```bash
qiime metadata tabulate\
    --m-input-file taxonomy.qza\
    --o-visualization taxonomy.qzv
```
    
```bash
qiime taxa barplot\
    --i-table feat-table-T4.qza\
    --i-taxonomy taxonomy.qza\
    --m-metadata-file metadata.tsv\
    --o-visualization taxa-bar-plots.qzv
```

Para entregar:

- Anexe la visualización de la taxonomía y de los Bar plots en Qiime view organizándolos por su locación

- Observe y señale que acciones le permite Qiime view realizar al archivo de visualización.

- Anexe *Bar plots* con nivel taxonómico de filum y género, y señale las diferencias en las abundancias entre dichos gráficos.

## III. Analisis de diversidad alfa

Recordemos algunas cosas: En el taller pasado ejecutaron dada2 y obtuvieron varios archivos de salida. Entre ellos la tabla de ASVs. Para este taller los datos serán los mismos (10 peces de mar y río) los cuales habrán cambiado un poco con esta tabla usted podrá realizar los análisis de este Taller

8. Lo primero a realizar será usar el plugin de *alpha diversity* de qiime para obtener 3 índices de alfa diversidad: shannon, simpson y chao1

```bash
qiime diversity alpha\
    --i-table feat-table-T4.qza\
    --p-metric X\
    --o-alpha-diversity X.qza
```

9. Ahora visualice los índices de diversidad obtenidos en *qiime view* con el comando:

```bash
qiime diversity alpha-correlation\
    --i-alpha-diversity X\
    --m-metadata-file X\
    --o-visualization X.qzv
```

Para entregar:

- Analice este índice diferenciando por locación (río vs mar) en cada métrica

## IV. Rarificar los datos

10. Ahora espere. Tómese un momento para preguntarse si lo que acaba de hacer está del todo bien... ¡Acaba de realizar un análisis sin rarificar sus datos!

Para entregar:

- Porqué es importante realizar rarefacción de los datos al hacer análisis de diversidad y que pasaría si se omite dicho paso.

11. Ahora aprenderán a rarificar: lo primero será visualizar un summary de su feature table con el siguiente comando:

```bash
qiime feature-table summarize\
    --i-table feat-table-T4.qza\
    --o-visualization X.qzv\
    --m-sample-metadata-file X
```

Al visualizar este archivo qzv podrá observar una tabla muy larga con los conteos de reads para cada muestra (pez).

Para entregar:

- ¿Cuál de esos valores escogería para hacer la rarefacción y por qué?

- Vuelva a realizar la alfa diversidad con los mismos tres índices y señale las principales diferencias. Puede realizar esto con el comando que se muestra a continuación y después visualice como en el punto anterior:

```bash
qiime diversity alpha-rarefaction\
    --i-table feat-table-T4\
    --p-max-depth X\
    --p-metrics X\
    --m-metadata-file X\
    --o-visualization X.qzv\
```

## V. Análisis de diversidad beta

12. Por último aprenderá a realizar diversidad beta con un plugin llamado `core-metrics`. Lo primero será realizar los árboles filogenéticos como en el taller anterior:

```bash
qiime phylogeny align-to-tree-mafft-fasttree \
    --i-sequences 16s-rep-seqs.qza\
    --o-alignment aligned-reps.qza\
    --o-masked-alignment masked-aligned.qza\
    --o-tree unrooted-tree.qza\
    --o-rooted-tree rooted-tree.qza
```

13. Por último realizará los análisis de core metrics, tenga en cuenta que los resultados serán enviados a una carpeta que usted dará nombre, lo podrá ejecutar con el siguiente comando: 

```bash
qiime diversity core-metrics-phylogenetic\
    --i-phylogeny rooted-tree.qza\
    -i-table feat-table-T4.qza\
    --p-sampling-depth X\
    --m-metadata-file metadata-Taller4.tsv\
    --output-dir core-metrics-results
```

Para entregar:

- Obtendrá varios archivos de visualización, Analice los resultados de *bray-curtis*, *unweighted unifrac* y *unweighted unifrac* haciendo diferenciación de colores entre los peces de río y los de mar.


