{"title":"Análisis de diversidad","markdown":{"headingText":"Análisis de diversidad","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n::: {.callout-tip appearance=\"simple\"}\n## Objetivos\nExplorar el flujo de Qiime2 para analizar la diversidad microbiana, considerando la influencia de la profundidad de muestreo, la dependencia de las probabilidades en la evaluación de la diversidad, y realizar cálculos de índices de diversidad junto con curvas de rarefacción.\n:::\n\nUsted obtiene los mismos datos del Taller pasado, amplicones de 16s RNA de peces de mar y río, con la particularidad de que esta vez cada pez no tiene la misma cantidad de lecturas. Usted debe realizar análisis de diversidad de estas secuencias teniendo en cuenta la cantidad de datos que está asignando a cada análisis.\n\n## I. Preparación de ambiente de trabajo\n\n1. Ingrese a la cuenta del clúster.\n\n2. En vez de crear una carpeta copiara la carpeta completa de `datasets`\n\n3. Copie todo el directorio de `Datasets/Taller_4/` a su directorio `Taller4`\n\n4. Ejecute los comandos de este taller en una sesión interactiva preferiblemente con 10G de memoria y al menos 4 cpus per task.\n\n5. Cargue el módulo de QIIME2 disponible en el clúster.\n\n:::{.callout-note appearance=\"simple\"}\nA lo largo del taller tendrá menos ayudas que en anterior, de no saber que ingresar en los *flags* de los comandos use `–help` para ver que archivos requiere. Anexe también imágenes de los pasos realizados para el resto del taller\n:::\n\n## II. Asignación taxonómica\n\n6. primero va a realizar una asignación taxonómica de los datos con el plugin de `sklearn` utilizando la base de datos anteriormente entrenada de SILVA.\n\n:::{.callout-important appearance=\"simple\"}\nEn la carpeta que copió verá el archivo `clasificación.sh`. Primero modifique para que las rutas absolutas coincidan con sus archivos y segundo ejecútelo con `sbatch` (es decir como un *job*) ¿Qué hacer si no sabe si está corriendo?: utilice el comando `squeue –u $USER` y busque en la primera columna su código, si no está allí es porque no está corriendo y deberá ejecutarlo de nuevo.\n:::\n\n7. una vez obtenido el `taxonomy.qza` realizará la diferentes visualizaciones de este artefacto con los siguientes comandos:\n\n```bash\nqiime metadata tabulate\\\n    --m-input-file taxonomy.qza\\\n    --o-visualization taxonomy.qzv\n```\n    \n```bash\nqiime taxa barplot\\\n    --i-table feat-table-T4.qza\\\n    --i-taxonomy taxonomy.qza\\\n    --m-metadata-file metadata.tsv\\\n    --o-visualization taxa-bar-plots.qzv\n```\n\nPara entregar:\n\n- Anexe la visualización de la taxonomía y de los Bar plots en Qiime view organizándolos por su locación\n\n- Observe y señale que acciones le permite Qiime view realizar al archivo de visualización.\n\n- Anexe *Bar plots* con nivel taxonómico de filum y género, y señale las diferencias en las abundancias entre dichos gráficos.\n\n## III. Analisis de diversidad alfa\n\nRecordemos algunas cosas: En el taller pasado ejecutaron dada2 y obtuvieron varios archivos de salida. Entre ellos la tabla de ASVs. Para este taller los datos serán los mismos (10 peces de mar y río) los cuales habrán cambiado un poco con esta tabla usted podrá realizar los análisis de este Taller\n\n8. Lo primero a realizar será usar el plugin de *alpha diversity* de qiime para obtener 3 índices de alfa diversidad: shannon, simpson y chao1\n\n```bash\nqiime diversity alpha\\\n    --i-table feat-table-T4.qza\\\n    --p-metric X\\\n    --o-alpha-diversity X.qza\n```\n\n9. Ahora visualice los índices de diversidad obtenidos en *qiime view* con el comando:\n\n```bash\nqiime diversity alpha-correlation\\\n    --i-alpha-diversity X\\\n    --m-metadata-file X\\\n    --o-visualization X.qzv\n```\n\nPara entregar:\n\n- Analice este índice diferenciando por locación (río vs mar) en cada métrica\n\n## IV. Rarificar los datos\n\n10. Ahora espere. Tómese un momento para preguntarse si lo que acaba de hacer está del todo bien... ¡Acaba de realizar un análisis sin rarificar sus datos!\n\nPara entregar:\n\n- Porqué es importante realizar rarefacción de los datos al hacer análisis de diversidad y que pasaría si se omite dicho paso.\n\n11. Ahora aprenderán a rarificar: lo primero será visualizar un summary de su feature table con el siguiente comando:\n\n```bash\nqiime feature-table summarize\\\n    --i-table feat-table-T4.qza\\\n    --o-visualization X.qzv\\\n    --m-sample-metadata-file X\n```\n\nAl visualizar este archivo qzv podrá observar una tabla muy larga con los conteos de reads para cada muestra (pez).\n\nPara entregar:\n\n- ¿Cuál de esos valores escogería para hacer la rarefacción y por qué?\n\n- Vuelva a realizar la alfa diversidad con los mismos tres índices y señale las principales diferencias. Puede realizar esto con el comando que se muestra a continuación y después visualice como en el punto anterior:\n\n```bash\nqiime diversity alpha-rarefaction\\\n    --i-table feat-table-T4\\\n    --p-max-depth X\\\n    --p-metrics X\\\n    --m-metadata-file X\\\n    --o-visualization X.qzv\\\n```\n\n## V. Análisis de diversidad beta\n\n12. Por último aprenderá a realizar diversidad beta con un plugin llamado `core-metrics`. Lo primero será realizar los árboles filogenéticos como en el taller anterior:\n\n```bash\nqiime phylogeny align-to-tree-mafft-fasttree \\\n    --i-sequences 16s-rep-seqs.qza\\\n    --o-alignment aligned-reps.qza\\\n    --o-masked-alignment masked-aligned.qza\\\n    --o-tree unrooted-tree.qza\\\n    --o-rooted-tree rooted-tree.qza\n```\n\n13. Por último realizará los análisis de core metrics, tenga en cuenta que los resultados serán enviados a una carpeta que usted dará nombre, lo podrá ejecutar con el siguiente comando: \n\n```bash\nqiime diversity core-metrics-phylogenetic\\\n    --i-phylogeny rooted-tree.qza\\\n    -i-table feat-table-T4.qza\\\n    --p-sampling-depth X\\\n    --m-metadata-file metadata-Taller4.tsv\\\n    --output-dir core-metrics-results\n```\n\nPara entregar:\n\n- Obtendrá varios archivos de visualización, Analice los resultados de *bray-curtis*, *unweighted unifrac* y *unweighted unifrac* haciendo diferenciación de colores entre los peces de río y los de mar.\n\n\n::: {.callout-note}\n## VI. Análisis de diversidad usando microviz\n\nPara este punto usted ya habrá aprendido a realizar análisis de diversidad en Qiime2, pero ahora aprenderá a realizarlos en R. Para esto usará el paquete `microviz` en R.\n\n1. Luego de instalar el paquete, podrá ingresar los archivos que resultado del análisis y preprocesarlos correctamente:\n\n```r\nOTU <- vroom(\"OTU_table.txt\", delim = \"\\t\", col_names = T)\nTax <- vroom(\"Tax_table.txt\", delim = \"\\t\", col_names = T)\nMetadata <- vroom(\"Metadata_table.txt\", delim = \"\\t\", col_names = T)\n```\n\nAlgunos reajustes a la tabla de OTU y Metadata:\n\n```r\nMetadata <- column_to_rownames(Metadata, var = \"sampleID\") \nMETA <- sample_data(Metadata)\n```\n\n```r\nOTU <- OTU |>\n  column_to_rownames(var = \"otuID\")\n\nOTU <- as.matrix(OTU)\n```\n\n```r\nTax <- Tax |>\n  column_to_rownames(var = \"otuID\")\n\nTax <- as.matrix(Tax)\n```\n\n2. Ahora podra crear una instancia de los archivos en una estructura conocida como `phyloseq`\n\n```r\nOTUps <- otu_table(OTU, taxa_are_rows = TRUE)\nTAXps <- tax_table(Tax)\n\nps0 <- phyloseq(OTUps, TAXps)\nps0\n\nphyloseqOBJ <- merge_phyloseq(ps0,META)\n```\n\n3. Explore los datos con el siguiente comando:\n\n```r\nord_explore(phyloseqOBJ)\n```\n\n4. Ahora podrá hacer manipulación de los datos, filtrarlos y seleccionar los que desee para el análisis. Por ejemplo, Podemos filtrar usando el archivo de metadatos. usando `ps_filter()` podemos mantener sólo las muestras con `sample_data` que coincidan con una o más condiciones:\n\n```r\npartial_ps <- phyloseqOBJ |>\n  ps_filter(\n    gender == \"female\",\n    activity %in% c(\"mild\", \"severe\"),\n    age >= 13\n  )\n```\n\n5. Fijar la taxonomía: `microviz` no puede manejar los niveles taxonómicos vacíos por lo que para las OTU con baja resolución taxonómica, se debe utilizar el nivel superior.\n\n```r\ntax_table(phyloseqOBJ)[40:54, 4:7]\n```\n\nSe observan varios NA, luego podemos fijarla usando:\n\n```r\nphyloseqOBJ <- phyloseqOBJ |>\n  tax_fix()\n\ntax_table(phyloseqOBJ)[40:54, 4:7]\n```\n\n6. Un paso importante en los análisis de diversidad es remover las muestras que no tienen suficientes lecturas es decir de baja abundancia y prevalencia. \n\n```r\nphyloseqOBJ <- phyloseqOBJ |>\n  tax_filter(\n  min_prevalence = 0.1, # <1> \n  prev_detection_threshold = 1,\n  min_total_abundance = 0,\n  min_sample_abundance = 0, # <2> \n  tax_level = NA\n)\n```\n1. Los OTU tienen que estar en el 10% de las muestras.\n2. Recuento mínimo requerido (o valor) para que un taxón se considere presente en esa muestra.\n\nAhora bien, nos podemos preguntar varias cosas sobre los datos, para esto debemos hacer varias transformaciones.\n\n7. Transformación de los datos. La transformación de los datos dependerá del tipo de métrica o análisis que se vaya a utilizar: \n\nConsidere la posibilidad de transformar los recuentos microbianos, por ejemplo, utilizando la transformación \"clr\" (centred log ratio), que a menudo se recomienda para los datos de composición (como los datos de secuenciación) \n\nAlgunos métodos, como PCoA, requieren una matriz de distancias entre pares de muestras, Normalmente NO debe transformar sus datos cuando utilice un método basado en distancias.\n\n\n```r\nphyloseqOBJ |>\n  tax_transform(trans = \"clr\", rank = \"Genus\")\n```\n\n```r\nphyloseqOBJ |>\n  tax_transform(trans = \"identity\", rank = \"Genus\") |>\n  dist_calc(\"bray\")\n```\n\n8. Graficos de ordenamiento de datos: PCA y PCoA. \n\nEl Análisis de Componentes Principales (PCA) se destaca por ser un método no restringido que prescinde de una matriz de distancias. En lugar de utilizar distancias, PCA trabaja directamente con las variables microbianas transformadas, evitando así la necesidad de emplear `dist_calc()`. Para llevar a cabo la ordenación, se utiliza `ord_calc()`, que agrega esta información al objeto `psExtra`. Posteriormente, la creación del gráfico de dispersión `ggplot2` se realiza mediante `ord_plot()`.\n\n```r\nphyloseqOBJ |>\n  tax_transform(\"clr\", rank = \"Genus\") |> \n  ord_calc(method = \"PCA\") |> #<1>\n  ord_plot(\n    color = \"ibd\",\n    shape = \"DiseaseState\",\n    plot_taxa = 1:5,\n    size = 2\n    ) +\n  scale_colour_brewer(palette = \"Dark2\")\n```\n1. Cuando no se proporciona ninguna matriz de distancias ni restricciones, PCA es el método de ordenación por defecto/automático.\n\nEl análisis de coordenadas principales también es un método sin restricciones, pero requiere una matriz de distancias. En un contexto ecológico, una medida de distancia (o más generalmente de \"disimilitud\") indica lo diferentes que son un par de ecosistemas (microbianos). Puede calcularse de muchas formas.\n\n\n```r\nphyloseqOBJ |>\n  tax_transform(\"identity\", rank = \"Genus\") |>\n  dist_calc(dist = \"jaccard\", binary = TRUE) |>\n  ord_calc(\"PCoA\") |>\n  ord_plot(color = \"ibd\", shape = \"DiseaseState\", size = 2) +\n  scale_colour_brewer(palette = \"Dark2\")\n```\n\n9. Análisis de redundancia (RDA)\n\nEl análisis de redundancia (RDA) es un método de ordenación restringida. Muestra la variación microbiana que también puede ser explicada por las variables de restricción seleccionadas.\n\nPor detras, se crea un modelo de regresión lineal para cada variable de abundancia microbiana (utilizando las restricciones como variables explicativas) y se realiza un PCA utilizando los valores ajustados de las abundancias microbianas.\n\nTraducción realizada con la versión gratuita del traductor www.DeepL.com/Translator\n\n```r\nphyloseqOBJ |>\n  ps_mutate(\n    IBD = as.numeric(ibd == \"ibd\"),\n    Female = as.numeric(gender == \"female\"),\n    Abx. = as.numeric(abx == \"abx\")\n  ) |>\n  tax_transform(\"clr\", rank = \"Genus\") |>\n  ord_calc(constraints = c(\"IBD\", \"Female\", \"Abx.\"), method = \"RDA\") |>\n  ord_plot(\n    colour = \"DiseaseState\", \n    size = 2,\n    alpha = 0.5,\n    shape = \"active\",\n    plot_taxa = 1:8\n  )\n```\n\n10. Análisis de composición de comunidades (CCA).\n\n```r\nphyloseqOBJ |>\n  ps_filter(gender == \"female\") |>\n  comp_barplot(\n    tax_level = \"Genus\",\n    label = \"DiseaseState\", #<1>\n    n_taxa = 15, #<2>\n    taxon_renamer = function(x) stringr::str_replace_all(x, \"_\", \" \"), #<3> \n    other_name = \"Other genera\", #<4> \n    merge_other = FALSE, #<5>\n    bar_width = 0.7, #<6>\n    bar_outline_colour = \"grey5\" #<7> \n  ) +\n  coord_flip()\n```\n1. Nombrar una variable alternativa para etiquetar el eje\n2. Dar colores únicos a más taxones\n3. Eliminar los guiones bajos\n4. Establecer un nombre personalizado para la categoría \"Otros\"\n5. Dividir la categoría \"Otros\" para mostrar la diversidad alfa\n6. Reducir la anchura de la barra al 70% de una fila\n7. Ws el valor por defecto (utilice `NA` para eliminar los contornos)\n:::\n\n\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":true,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"center","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"ayu","embed-resources":true,"output-file":"04-diversity-analisis.html"},"language":{"toc-title-document":"Tabla de contenidos","toc-title-website":"En esta página","related-formats-title":"Otros formatos","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Fuente","other-links-title":"Otros Enlaces","code-links-title":"Enlaces de código","launch-dev-container-title":"Iniciar Dev Container","launch-binder-title":"Iniciar Binder","article-notebook-label":"Cuaderno de Artículo","notebook-preview-download":"Descargar Cuaderno","notebook-preview-download-src":"Descargar código fuente","notebook-preview-back":"Volver al Artículo","manuscript-meca-bundle":"Archivo MECA","section-title-abstract":"Resumen","section-title-appendices":"Apéndices","section-title-footnotes":"Notas","section-title-references":"Referencias","section-title-reuse":"Reutilización","section-title-copyright":"Derechos de autor","section-title-citation":"Cómo citar","appendix-attribution-cite-as":"Por favor, cita este trabajo como:","appendix-attribution-bibtex":"BibTeX","title-block-author-single":"Autor/a","title-block-author-plural":"Autores/as","title-block-affiliation-single":"Afiliación","title-block-affiliation-plural":"Afiliaciones","title-block-published":"Fecha de publicación","title-block-modified":"Fecha de modificación","title-block-keywords":"Palabras clave","callout-tip-title":"Tip","callout-note-title":"Nota","callout-warning-title":"Advertencia","callout-important-title":"Importante","callout-caution-title":"Precaución","code-summary":"Código","code-tools-menu-caption":"Código","code-tools-show-all-code":"Mostrar todo el código","code-tools-hide-all-code":"Ocultar todo el código","code-tools-view-source":"Ver el código fuente","code-tools-source-code":"Ejecutar el código","tools-share":"Compartir","tools-download":"Descargar","code-line":"Línea","code-lines":"Líneas","copy-button-tooltip":"Copiar al portapapeles","copy-button-tooltip-success":"Copiado","repo-action-links-edit":"Editar esta página","repo-action-links-source":"Ver el código","repo-action-links-issue":"Informar de un problema","back-to-top":"Volver arriba","search-no-results-text":"Sin resultados","search-matching-documents-text":"documentos encontrados","search-copy-link-title":"Copiar el enlace en la búsqueda","search-hide-matches-text":"Ocultar resultados adicionales","search-more-match-text":"resultado adicional en este documento","search-more-matches-text":"resultados adicionales en este documento","search-clear-button-title":"Borrar","search-text-placeholder":"","search-detached-cancel-button-title":"Cancelar","search-submit-button-title":"Enviar","search-label":"Buscar","toggle-section":"Alternar sección","toggle-sidebar":"Alternar barra lateral","toggle-dark-mode":"Alternar modo oscuro","toggle-reader-mode":"Alternar modo lector","toggle-navigation":"Navegación de palanca","crossref-fig-title":"Figura","crossref-tbl-title":"Tabla","crossref-lst-title":"Listado","crossref-thm-title":"Teorema","crossref-lem-title":"Lema","crossref-cor-title":"Corolario","crossref-prp-title":"Proposición","crossref-cnj-title":"Conjetura","crossref-def-title":"Definición","crossref-exm-title":"Ejemplo","crossref-exr-title":"Ejercicio","crossref-ch-prefix":"Capítulo","crossref-apx-prefix":"Apéndice","crossref-sec-prefix":"Sección","crossref-eq-prefix":"Ecuación","crossref-lof-title":"Listado de Figuras","crossref-lot-title":"Listado de Tablas","crossref-lol-title":"Listado de Listados","environment-proof-title":"Prueba","environment-remark-title":"Observación","environment-solution-title":"Solución","listing-page-order-by":"Ordenar por","listing-page-order-by-default":"Por defecto","listing-page-order-by-date-asc":"Menos reciente","listing-page-order-by-date-desc":"Más reciente","listing-page-order-by-number-desc":"De mayor a menor","listing-page-order-by-number-asc":"De menor a mayor","listing-page-field-date":"Fecha","listing-page-field-title":"Título","listing-page-field-description":"Descripción","listing-page-field-author":"Autor/a","listing-page-field-filename":"Nombre de archivo","listing-page-field-filemodified":"Fecha de modificación","listing-page-field-subtitle":"Subtítulo","listing-page-field-readingtime":"Tiempo de lectura","listing-page-field-wordcount":"Conteo de Palabras","listing-page-field-categories":"Categorías","listing-page-minutes-compact":"{0} minutos","listing-page-category-all":"Todas","listing-page-no-matches":"No hay resultados","listing-page-words":"{0} palabras"},"metadata":{"lang":"es","fig-responsive":true,"quarto-version":"1.4.543","bibliography":["../references.bib"],"code-annotations":"select","theme":"cosmo","code-copy":"hover"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}